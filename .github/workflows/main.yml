name: Image Push Workflow
on:
  push:
    branches:
    - main
jobs:
  build_and_push:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Build image
      run: docker build -t my_image_2:latest --file Dockerfile.1 .
    - name: Scan image
      id: scan
      uses: sysdiglabs/scan-action@v4
      with:
        image-tag: my_image_2:latest
        sysdig-secure-token: 1293902d-2376-4ec4-af64-c4605434fb0e
        sysdig-secure-url: https://secure.sysdig.com
    - name: Upload SARIF file
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ github.workspace }}/sarif.json
    - name: Push image
      run: docker image inspect my_image_2:latest
      #- name: Approval
      #  id: approval
      #  uses: repo/approvals-action@v2
      #  with:
      #    approval_title: Approve Image Push
      #    approval_message: Please review and approve the image push to the registry
      #- name: Push image
      #  if: steps.approval.outputs.approved == 'true'
      #  run: docker push my_image:latest
